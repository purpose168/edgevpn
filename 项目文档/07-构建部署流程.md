# EdgeVPN 构建部署流程

## 1. 概述

本文档详细说明 EdgeVPN 项目的构建和部署流程，包括环境配置、构建步骤、部署流程及环境变量配置。EdgeVPN 支持多种部署方式，包括二进制部署、Docker 部署和源码部署。

## 2. 环境配置

### 2.1 开发环境

#### 2.1.1 系统要求

- **操作系统**：Linux、macOS、Windows、FreeBSD
- **Go 版本**：Go 1.24.6 或更高
- **磁盘空间**：至少 500MB
- **内存**：至少 512MB
- **网络**：需要互联网连接（用于依赖下载）

#### 2.1.2 必需工具

| 工具 | 版本 | 用途 |
|------|------|------|
| Git | 2.0+ | 版本控制 |
| Go | 1.24.6+ | 编译 |
| Make | 3.81+ | 构建工具 |

#### 2.1.3 可选工具

| 工具 | 版本 | 用途 |
|------|------|------|
| Docker | 20.10+ | 容器化部署 |
| Docker Compose | 1.29+ | 多容器编排 |
| Hugo | 0.146.0+ | 文档构建 |

### 2.2 生产环境

#### 2.2.1 系统要求

- **操作系统**：Linux（推荐）、macOS、Windows
- **CPU**：1 核或更多
- **内存**：1GB 或更多
- **磁盘空间**：至少 1GB
- **网络**：需要公网 IP 或 NAT 穿透能力

#### 2.2.2 权限要求

- **Linux**：需要 CAP_NET_ADMIN 权限（创建 TUN 设备）
- **macOS**：需要管理员权限
- **Windows**：需要管理员权限

## 3. 构建流程

### 3.1 从源码构建

#### 3.1.1 克隆仓库

```bash
# 克隆仓库
git clone https://github.com/mudler/edgevpn.git
cd edgevpn

# 检出特定版本（可选）
git checkout v1.0.0
```

#### 3.1.2 安装依赖

```bash
# 下载依赖
go mod download

# 验证依赖
go mod verify
```

#### 3.1.3 编译项目

```bash
# 编译当前平台
go build -o edgevpn ./main.go

# 编译所有平台（使用 GoReleaser）
goreleaser build --clean --snapshot

# 或使用 Makefile（如果存在）
make build
```

#### 3.1.4 静态编译

```bash
# 设置环境变量
export CGO_ENABLED=0

# 编译
go build -ldflags="-s -w" -o edgevpn ./main.go
```

### 3.2 使用 GoReleaser 构建

#### 3.2.1 安装 GoReleaser

```bash
# 使用 Homebrew（macOS）
brew install goreleaser

# 使用 Go install
go install github.com/goreleaser/goreleaser/v2@latest
```

#### 3.2.2 配置 GoReleaser

项目已包含 `.goreleaser.yml` 配置文件：

```yaml
version: 2
builds:
  - ldflags:
      - -w -s
      - -X github.com/mudler/edgevpn/internal.Version={{.Tag}}
      - -X github.com/mudler/edgevpn/internal.Commit={{.Commit}}
    env:
      - CGO_ENABLED=0
    goos:
      - linux
      - windows
      - darwin
      - freebsd
    goarch:
      - amd64
      - arm
      - 386
      - arm64
```

#### 3.2.3 执行构建

```bash
# 构建所有平台
goreleaser build --clean

# 构建快照版本
goreleaser build --clean --snapshot

# 发布版本
goreleaser release
```

### 3.3 使用 Docker 构建

#### 3.3.1 Dockerfile

项目已包含 `Dockerfile`：

```dockerfile
# 构建阶段
FROM golang:1.25-alpine as builder
ENV LDFLAGS=-s -w CGO_ENABLED=0
ADD . /work
WORKDIR /work
RUN apk add --no-cache git && \
    go build -ldflags="$LDFLAGS" -o edgevpn

# 运行阶段
FROM alpine
COPY --from=builder /work/edgevpn /usr/bin/edgevpn
ENTRYPOINT ["/usr/bin/edgevpn"]
```

#### 3.3.2 构建镜像

```bash
# 构建镜像
docker build -t edgevpn:latest .

# 构建带标签的镜像
docker build -t edgevpn:v1.0.0 .
```

## 4. 部署流程

### 4.1 二进制部署

#### 4.1.1 下载预编译二进制

```bash
# 从 GitHub Releases 下载
wget https://github.com/mudler/edgevpn/releases/download/v1.0.0/edgevpn-v1.0.0-linux-amd64

# 或使用 curl
curl -LO https://github.com/mudler/edgevpn/releases/download/v1.0.0/edgevpn-v1.0.0-linux-amd64

# 添加执行权限
chmod +x edgevpn-v1.0.0-linux-amd64

# 移动到系统路径
sudo mv edgevpn-v1.0.0-linux-amd64 /usr/local/bin/edgevpn
```

#### 4.1.2 生成配置

```bash
# 生成配置文件
edgevpn -g > config.yaml

# 或生成令牌
EDGEVPNTOKEN=$(edgevpn -g -b)
echo $EDGEVPNTOKEN
```

#### 4.1.3 启动服务

```bash
# 使用配置文件启动
edgevpn --config config.yaml

# 或使用令牌启动
EDGEVPNTOKEN=your_token_here edgevpn

# 启用 API
edgevpn --config config.yaml --api --api-listen 127.0.0.1:8080
```

### 4.2 Docker 部署

#### 4.2.1 使用 Docker Compose

项目已包含 `docker-compose.yml`：

```yaml
services:
  edgevpn:
    image: quay.io/mudler/edgevpn:latest
    pull_policy: always
    container_name: edgevpn
    restart: unless-stopped
    volumes:
      - /home/CHANGEME/.edgevpn:/root/.edgevpn
    environment:
      - EDGEVPNTOKEN=CHANGEME
    network_mode: host
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
    healthcheck:
      test: ["CMD", "sh", "-c", "ifconfig | grep -q edgevpn0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

#### 4.2.2 部署步骤

```bash
# 1. 修改 docker-compose.yml
# 将 EDGEVPNTOKEN 替换为实际令牌
# 将 /home/CHANGEME/.edgevpn 替换为实际路径

# 2. 启动服务
docker-compose up -d

# 3. 查看日志
docker-compose logs -f

# 4. 检查状态
docker-compose ps
```

#### 4.2.3 管理容器

```bash
# 停止服务
docker-compose stop

# 启动服务
docker-compose start

# 重启服务
docker-compose restart

# 删除服务
docker-compose down

# 查看日志
docker-compose logs -f edgevpn
```

### 4.3 系统服务部署

#### 4.3.1 创建 systemd 服务

创建 `/etc/systemd/system/edgevpn.service`：

```ini
[Unit]
Description=EdgeVPN Service
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/edgevpn --config /etc/edgevpn/config.yaml
Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

#### 4.3.2 管理服务

```bash
# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start edgevpn

# 停止服务
sudo systemctl stop edgevpn

# 重启服务
sudo systemctl restart edgevpn

# 查看状态
sudo systemctl status edgevpn

# 开机自启
sudo systemctl enable edgevpn
```

## 5. 环境变量配置

### 5.1 核心环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| EDGEVPNTOKEN | 网络令牌（base64 编码的配置） | 无 |
| EDGEVPNCONFIG | 配置文件路径 | 无 |
| API | 是否启用 API | false |
| APILISTEN | API 监听地址 | 127.0.0.1:8080 |
| DHCP | 是否启用 P2P IP 协商 | false |
| ADDRESS | VPN 虚拟地址 | 10.1.0.1/24 |
| DNSADDRESS | DNS 监听地址 | 空（禁用） |

### 5.2 网络环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| TRANSIENTCONN | 是否允许临时连接 | false |
| LEASEDIR | DHCP 租约目录 | ~/.edgevpn/leases |
| INTERFACE | VPN 接口名称 | edgevpn0 |
| INTERFACEMTU | 接口 MTU | 1420 |
| PACKETMTU | 数据包 MTU | 1280 |

### 5.3 资源限制环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| MAXCONNECTIONS | 最大连接数 | 100 |
| MAXSTREAMS | 最大流数量 | 30 |
| CONCURRENCY | 并发数 | 1 |

### 5.4 日志环境变量

| 变量名 | 说明 | 默认值 |
|--------|------|--------|
| LOGLEVEL | 日志级别 | info |
| LIBP2PLOGLEVEL | libp2p 日志级别 | info |
| DEBUG | 是否启用调试模式 | false |

### 5.5 配置示例

#### 5.5.1 使用环境变量

```bash
# 设置环境变量
export EDGEVPNTOKEN="your_token_here"
export API="true"
export APILISTEN="0.0.0.0:8080"
export ADDRESS="10.2.0.1/24"
export DNSADDRESS=":53"

# 启动
edgevpn
```

#### 5.5.2 使用配置文件

创建 `config.yaml`：

```yaml
network:
  token: "your_token_here"
  address: "10.2.0.1/24"
  interface: "edgevpn0"
  interface_mtu: 1420

api:
  enabled: true
  listen: "0.0.0.0:8080"

dhcp:
  enabled: true
  lease_dir: "/var/lib/edgevpn/leases"

dns:
  enabled: true
  listen: ":53"
  forwarder: true
  forward:
    - "8.8.8.8:53"
    - "8.8.4.4:53"

logging:
  level: "info"
  libp2p_level: "info"
```

#### 5.5.3 使用命令行参数

```bash
edgevpn \
  --token "your_token_here" \
  --address "10.2.0.1/24" \
  --api \
  --api-listen "0.0.0.0:8080" \
  --dhcp \
  --dns ":53"
```

## 6. CI/CD 部署

### 6.1 GitHub Actions

项目使用 GitHub Actions 进行自动化构建和部署。

#### 6.1.1 构建工作流

`.github/workflows/build.yml`：

```yaml
name: Build

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: v2.0.1
          args: build --clean --snapshot
```

#### 6.1.2 发布工作流

`.github/workflows/release.yml`：

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.25
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: v2.0.1
          args: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

#### 6.1.3 镜像构建工作流

`.github/workflows/images.yml`：

```yaml
name: Images

on:
  push:
    branches:
      - main

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Quay
        uses: docker/login-action@v3
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_USERNAME }}
          password: ${{ secrets.QUAY_PASSWORD }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: quay.io/mudler/edgevpn:latest
```

### 6.2 自动化部署

#### 6.2.1 部署脚本

创建 `deploy.sh`：

```bash
#!/bin/bash

# 配置
VERSION="v1.0.0"
BINARY_URL="https://github.com/mudler/edgevpn/releases/download/${VERSION}/edgevpn-${VERSION}-linux-amd64"
CONFIG_FILE="/etc/edgevpn/config.yaml"

# 下载二进制
echo "Downloading EdgeVPN ${VERSION}..."
wget -O /tmp/edgevpn ${BINARY_URL}
chmod +x /tmp/edgevpn

# 停止服务
echo "Stopping EdgeVPN service..."
sudo systemctl stop edgevpn

# 备份旧版本
if [ -f /usr/local/bin/edgevpn ]; then
    sudo cp /usr/local/bin/edgevpn /usr/local/bin/edgevpn.backup
fi

# 安装新版本
echo "Installing new version..."
sudo mv /tmp/edgevpn /usr/local/bin/edgevpn

# 启动服务
echo "Starting EdgeVPN service..."
sudo systemctl start edgevpn

# 检查状态
sudo systemctl status edgevpn
```

#### 6.2.2 使用部署脚本

```bash
# 添加执行权限
chmod +x deploy.sh

# 执行部署
./deploy.sh
```

## 7. 监控和日志

### 7.1 日志管理

#### 7.1.1 查看日志

```bash
# 使用 systemd
sudo journalctl -u edgevpn -f

# 使用 Docker
docker-compose logs -f

# 使用文件
tail -f /var/log/edgevpn.log
```

#### 7.1.2 日志级别

```bash
# 设置日志级别
export LOGLEVEL=debug

# 或在配置文件中
logging:
  level: "debug"
```

### 7.2 健康检查

#### 7.2.1 API 健康检查

```bash
# 检查 API
curl http://localhost:8080/api/summary

# 检查 VPN 接口
ifconfig edgevpn0

# 检查进程
ps aux | grep edgevpn
```

#### 7.2.2 自动健康检查

```bash
#!/bin/bash

# 健康检查脚本
HEALTH_URL="http://localhost:8080/api/summary"
INTERFACE="edgevpn0"

# 检查 API
if ! curl -f -s ${HEALTH_URL} > /dev/null; then
    echo "API health check failed"
    exit 1
fi

# 检查 VPN 接口
if ! ifconfig ${INTERFACE} > /dev/null 2>&1; then
    echo "VPN interface check failed"
    exit 1
fi

echo "All health checks passed"
```

## 8. 故障排除

### 8.1 常见问题

#### 8.1.1 权限问题

**问题**：无法创建 TUN 设备

**解决方案**：

```bash
# 添加 CAP_NET_ADMIN 权限
sudo setcap cap_net_admin+ep /usr/local/bin/edgevpn

# 或使用 sudo 运行
sudo edgevpn
```

#### 8.1.2 网络问题

**问题**：无法连接到其他节点

**解决方案**：

```bash
# 检查防火墙
sudo ufw status

# 开放必要端口
sudo ufw allow 4001/tcp
sudo ufw allow 4001/udp

# 检查 NAT
curl ifconfig.me
```

#### 8.1.3 配置问题

**问题**：配置文件格式错误

**解决方案**：

```bash
# 验证 YAML 格式
python -c "import yaml; yaml.safe_load(open('config.yaml'))"

# 或使用在线工具
# https://www.yamllint.com/
```

### 8.2 调试模式

```bash
# 启用调试模式
edgevpn --debug

# 启用详细日志
export LOGLEVEL=debug
export LIBP2PLOGLEVEL=debug
edgevpn
```

## 9. 升级流程

### 9.1 升级步骤

```bash
# 1. 备份配置
cp /etc/edgevpn/config.yaml /etc/edgevpn/config.yaml.backup

# 2. 停止服务
sudo systemctl stop edgevpn

# 3. 下载新版本
wget https://github.com/mudler/edgevpn/releases/download/v1.1.0/edgevpn-v1.1.0-linux-amd64

# 4. 替换二进制
sudo mv edgevpn-v1.1.0-linux-amd64 /usr/local/bin/edgevpn
sudo chmod +x /usr/local/bin/edgevpn

# 5. 启动服务
sudo systemctl start edgevpn

# 6. 验证升级
sudo systemctl status edgevpn
```

### 9.2 回滚步骤

```bash
# 1. 停止服务
sudo systemctl stop edgevpn

# 2. 恢复旧版本
sudo mv /usr/local/bin/edgevpn.backup /usr/local/bin/edgevpn

# 3. 启动服务
sudo systemctl start edgevpn

# 4. 验证回滚
sudo systemctl status edgevpn
```

## 10. 安全建议

### 10.1 令牌管理

- 不要在代码中硬编码令牌
- 使用环境变量或密钥管理系统
- 定期轮换令牌
- 使用强随机密钥

### 10.2 网络安全

- 使用防火墙限制访问
- 启用 TLS 加密
- 配置信任区域
- 监控异常连接

### 10.3 系统安全

- 定期更新系统
- 使用最小权限原则
- 启用审计日志
- 定期备份配置

## 11. 总结

EdgeVPN 提供了多种构建和部署方式，开发者可以根据实际需求选择合适的方式。遵循本文档的流程和建议，可以顺利地完成 EdgeVPN 的构建和部署。

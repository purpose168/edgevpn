# EdgeVPN 项目架构概述

## 1. 项目简介

EdgeVPN 是一个基于 libp2p 构建的完全去中心化的私有网络解决方案。它使用共享密钥创建可访问的去中心化网络，提供 VPN、反向代理、P2P 文件传输和区块链账本等功能。

### 1.1 核心特性

- **完全去中心化**：无需中央服务器，所有节点对等
- **不可变**：基于区块链的账本系统，确保数据一致性
- **便携**：静态编译的二进制文件，易于部署
- **易于使用**：通过令牌或配置文件快速建立网络

### 1.2 主要功能

- **创建 VPN**：在 P2P 对等节点之间建立安全 VPN
  - 自动为节点分配 IP 地址
  - 内置微型 DNS 服务器用于解析内部/外部 IP
  - 创建可信区域以防止令牌泄露时的网络访问

- **反向代理**：像使用 ngrok 一样共享 TCP 服务
  - 将 TCP 服务暴露给 P2P 网络节点
  - 无需建立 VPN 连接即可实现流量隧道化

- **P2P 文件传输**：在节点之间通过 P2P 发送文件
  - 无需建立 VPN 连接
  - 直接通过 P2P 网络传输

- **区块链账本**：提供分布式账本功能
  - 用于节点发现和服务注册
  - 支持 DNS 记录管理
  - 可作为库集成到其他 Go 应用中

## 2. 系统架构设计

### 2.1 整体架构

EdgeVPN 采用分层架构设计，从底层到上层依次为：

```mermaid
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#E3F2FD', 'primaryTextColor': '#1565C0', 'primaryBorderColor': '#1976D2', 'lineColor': '#42A5F5', 'secondaryColor': '#FFF3E0', 'tertiaryColor': '#E8F5E9'}}}%%

flowchart TB
    subgraph APP["🖥️ 应用层 (Application Layer)"]
        direction LR
        CLI["📋 CLI<br/>命令行接口"]
        API["🔌 API<br/>REST API 服务"]
        GUI["🖼️ GUI<br/>图形用户界面"]
        LIB["📚 Library<br/>Go 库集成"]
    end

    subgraph SVC["⚙️ 服务层 (Services Layer)"]
        direction LR
        VPN["🔐 VPN 服务<br/>虚拟专用网络"]
        DNS["🌐 DNS 服务<br/>域名解析"]
        FILE["📁 文件服务<br/>P2P 文件传输"]
        PROXY["🔄 代理服务<br/>反向代理/隧道"]
    end

    subgraph CORE["🧠 核心层 (Core Layer)"]
        direction LR
        NODE["🤖 节点管理<br/>Node Manager"]
        LEDGER["📖 区块链账本<br/>Blockchain Ledger"]
        HUB["📡 消息中心<br/>Message Hub"]
        TZ["🛡️ 信任区域<br/>Trust Zone"]
    end

    subgraph NET["🌐 网络层 (Network Layer)"]
        direction LR
        LIBP2P["🔗 libp2p 主机<br/>P2P 主机"]
        DHT["🔍 DHT 发现<br/>分布式哈希表"]
        PUBSUB["📢 PubSub 消息<br/>发布订阅"]
        DISC["🔎 发现服务<br/>节点发现"]
    end

    subgraph TRANS["🚀 传输层 (Transport Layer)"]
        direction LR
        TCP["📦 TCP/UDP<br/>传输协议"]
        WEBRTC["🎥 WebRTC<br/>实时通信"]
        QUIC["⚡ QUIC<br/>快速 UDP"]
        OTHER["🔧 其他协议<br/>扩展传输"]
    end

    %% 应用层到服务层的连接
    CLI -->|"调用服务"| VPN
    CLI -->|"调用服务"| DNS
    API -->|"提供接口"| VPN
    API -->|"提供接口"| FILE
    GUI -->|"用户操作"| VPN
    GUI -->|"用户操作"| PROXY
    LIB -->|"库调用"| VPN
    LIB -->|"库调用"| LEDGER

    %% 服务层到核心层的连接
    VPN -->|"节点通信"| NODE
    VPN -->|"状态同步"| LEDGER
    DNS -->|"记录存储"| LEDGER
    FILE -->|"数据传输"| HUB
    PROXY -->|"连接管理"| NODE

    %% 核心层内部连接
    NODE <-->|"账本操作"| LEDGER
    NODE <-->|"消息传递"| HUB
    NODE <-->|"安全认证"| TZ
    LEDGER <-->|"状态广播"| HUB

    %% 核心层到网络层的连接
    NODE -->|"P2P 通信"| LIBP2P
    HUB -->|"消息订阅"| PUBSUB
    LEDGER -->|"数据同步"| PUBSUB
    TZ -->|"节点验证"| DHT

    %% 网络层内部连接
    LIBP2P <-->|"路由查询"| DHT
    LIBP2P <-->|"消息通道"| PUBSUB
    LIBP2P <-->|"节点发现"| DISC
    DHT <-->|"发现节点"| DISC

    %% 网络层到传输层的连接
    LIBP2P -->|"传输数据"| TCP
    LIBP2P -->|"传输数据"| WEBRTC
    LIBP2P -->|"传输数据"| QUIC
    LIBP2P -->|"传输数据"| OTHER

    %% 样式定义
    classDef appStyle fill:#E3F2FD,stroke:#1976D2,stroke-width:2px,color:#1565C0
    classDef svcStyle fill:#FFF3E0,stroke:#F57C00,stroke-width:2px,color:#E65100
    classDef coreStyle fill:#E8F5E9,stroke:#388E3C,stroke-width:2px,color:#1B5E20
    classDef netStyle fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px,color:#4A148C
    classDef transStyle fill:#FFEBEE,stroke:#C62828,stroke-width:2px,color:#B71C1C

    class CLI,API,GUI,LIB appStyle
    class VPN,DNS,FILE,PROXY svcStyle
    class NODE,LEDGER,HUB,TZ coreStyle
    class LIBP2P,DHT,PUBSUB,DISC netStyle
    class TCP,WEBRTC,QUIC,OTHER transStyle
```

### 2.2 核心组件关系

#### 2.2.1 节点 (Node)

节点是 EdgeVPN 网络的基本单元，每个节点包含：

- **libp2p 主机**：提供 P2P 网络通信能力
- **消息中心**：管理 PubSub 消息传递
- **区块链账本**：维护分布式账本状态
- **连接门控器**：控制对等节点的连接

#### 2.2.2 区块链账本 (Blockchain Ledger)

区块链账本提供：

- **数据存储**：键值对形式的分布式存储
- **状态同步**：通过 GossipSub 协议同步账本状态
- **数据公告**：定期向网络公告数据
- **数据持久化**：支持内存和磁盘存储

#### 2.2.3 消息中心 (Message Hub)

消息中心负责：

- **PubSub 管理**：创建和管理 GossipSub 主题
- **消息路由**：在区块链和公共房间之间路由消息
- **主题管理**：基于 OTP 密钥生成主题密钥

#### 2.2.4 信任区域 (Trust Zone)

信任区域提供：

- **对等节点认证**：支持 ECDSA 等认证机制
- **访问控制**：控制哪些节点可以加入网络
- **自动清理**：清理不活跃的对等节点

### 2.3 技术架构图

```mermaid
graph TB
    subgraph "应用层"
        CLI[CLI 命令行]
        API[REST API]
        GUI[图形界面]
        LIB[Go 库]
    end

    subgraph "服务层"
        VPN[VPN 服务]
        DNS[DNS 服务]
        FILES[文件服务]
        PROXY[代理服务]
    end

    subgraph "核心层"
        NODE[节点管理]
        LEDGER[区块链账本]
        HUB[消息中心]
        TZ[信任区域]
    end

    subgraph "网络层"
        LIBP2P[libp2p 主机]
        DHT[DHT 发现]
        PUBSUB[PubSub 消息]
        DISC[发现服务]
    end

    CLI --> NODE
    API --> NODE
    GUI --> NODE
    LIB --> NODE

    VPN --> NODE
    DNS --> NODE
    FILES --> NODE
    PROXY --> NODE

    NODE --> LIBP2P
    NODE --> LEDGER
    NODE --> HUB
    NODE --> TZ

    LIBP2P --> DHT
    LIBP2P --> PUBSUB
    LIBP2P --> DISC

    HUB --> PUBSUB
    LEDGER --> HUB
```

## 3. 核心设计原则

### 3.1 去中心化

- **无单点故障**：所有节点功能对等
- **自组织**：网络自动形成和维护
- **抗审查**：无需中央服务器

### 3.2 安全性

- **加密通信**：所有 P2P 通信都经过加密
- **令牌认证**：通过共享密钥控制网络访问
- **信任区域**：可选的对等节点认证机制

### 3.3 可扩展性

- **模块化设计**：各组件独立可替换
- **插件架构**：支持自定义网络服务
- **水平扩展**：节点数量无限制

### 3.4 易用性

- **零配置**：通过令牌快速加入网络
- **自动发现**：节点自动发现和连接
- **跨平台**：支持 Linux、Windows、macOS、FreeBSD

## 4. 数据流设计

### 4.1 节点启动流程

```mermaid
flowchart TD
    subgraph INIT["🚀 节点启动流程"]
        direction TB
        A["1️⃣ 加载配置/令牌<br/>Load Config/Token"]
        B["2️⃣ 创建 libp2p 主机<br/>Create libp2p Host"]
        C["3️⃣ 初始化 DHT 发现服务<br/>Initialize DHT Discovery"]
        D["4️⃣ 加入 GossipSub 主题<br/>Join GossipSub Topics"]
        E["5️⃣ 同步区块链账本<br/>Sync Blockchain Ledger"]
        F["6️⃣ 启动网络服务<br/>Start Network Services"]
        G["✅ 节点就绪<br/>Node Ready"]
    end

    A -->|"读取配置文件"| B
    B -->|"P2P 主机创建完成"| C
    C -->|"DHT 节点引导"| D
    D -->|"订阅消息主题"| E
    E -->|"账本状态同步"| F
    F -->|"VPN/DNS/文件/代理"| G

    %% 样式定义
    classDef stepStyle fill:#E3F2FD,stroke:#1976D2,stroke-width:2px,color:#1565C0
    classDef finalStyle fill:#E8F5E9,stroke:#388E3C,stroke-width:3px,color:#1B5E20

    class A,B,C,D,E,F stepStyle
    class G finalStyle
```

### 4.2 数据同步流程

```mermaid
flowchart TD
    subgraph SYNC["🔄 数据同步流程"]
        direction TB
        A["1️⃣ 节点 A 修改账本数据<br/>Node A Modifies Ledger Data"]
        B["2️⃣ 节点 A 创建新区块<br/>Node A Creates New Block"]
        C["3️⃣ 节点 A 通过 PubSub 广播区块<br/>Node A Broadcasts via PubSub"]
        D["4️⃣ 其他节点接收并验证区块<br/>Other Nodes Receive & Verify"]
        E["5️⃣ 验证通过后更新本地账本<br/>Update Local Ledger After Verify"]
        F["✅ 账本状态同步完成<br/>Ledger Sync Complete"]
    end

    A -->|"数据变更"| B
    B -->|"区块构建"| C
    C -->|"GossipSub 广播"| D
    D -->|"哈希验证"| E
    E -->|"状态更新"| F

    %% 样式定义
    classDef stepStyle fill:#FFF3E0,stroke:#F57C00,stroke-width:2px,color:#E65100
    classDef finalStyle fill:#E8F5E9,stroke:#388E3C,stroke-width:3px,color:#1B5E20

    class A,B,C,D,E stepStyle
    class F finalStyle
```

### 4.3 VPN 数据包转发流程

```mermaid
flowchart TD
    subgraph VPN_FWD["📡 VPN 数据包转发流程"]
        direction TB
        A["1️⃣ 应用发送数据包到 VPN 接口<br/>App Sends Packet to VPN Interface"]
        B["2️⃣ VPN 接口捕获数据包<br/>VPN Interface Captures Packet"]
        C["3️⃣ 解析目标 IP 地址<br/>Parse Destination IP Address"]
        D["4️⃣ 查询账本获取目标节点 PeerID<br/>Query Ledger for Target PeerID"]
        E["5️⃣ 建立 P2P 流连接到目标节点<br/>Establish P2P Stream to Target"]
        F["6️⃣ 通过 P2P 流转发数据包<br/>Forward Packet via P2P Stream"]
        G["7️⃣ 目标节点接收并写入 VPN 接口<br/>Target Node Receives & Writes to VPN"]
        H["✅ 数据包到达目标应用<br/>Packet Arrives at Target App"]
    end

    A -->|"TUN/TAP 设备"| B
    B -->|"数据包解析"| C
    C -->|"IP 地址查询"| D
    D -->|"账本查找"| E
    E -->|"libp2p 流"| F
    F -->|"加密传输"| G
    G -->|"写入接口"| H

    %% 样式定义
    classDef stepStyle fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px,color:#4A148C
    classDef finalStyle fill:#E8F5E9,stroke:#388E3C,stroke-width:3px,color:#1B5E20

    class A,B,C,D,E,F,G stepStyle
    class H finalStyle
```

## 5. 部署架构

### 5.1 单节点部署

```mermaid
flowchart TB
    subgraph NODE["🖥️ EdgeVPN 单节点"]
        direction TB
        LIBP2P["🔗 libp2p 主机<br/>P2P 通信引擎"]
        LEDGER["📖 区块链账本<br/>分布式存储"]
        VPN["🔐 VPN 接口<br/>虚拟网络接口"]
    end

    LIBP2P <-->|"状态同步"| LEDGER
    LEDGER <-->|"数据路由"| VPN

    %% 样式定义
    classDef nodeStyle fill:#E3F2FD,stroke:#1976D2,stroke-width:2px,color:#1565C0

    class LIBP2P,LEDGER,VPN nodeStyle
```

### 5.2 多节点网络部署

```mermaid
flowchart LR
    subgraph P2P_NET["🌐 P2P 网络层"]
        direction LR
        NODE_A["🖥️ 节点 A<br/>IP: 10.1.0.1"]
        NODE_B["🖥️ 节点 B<br/>IP: 10.1.0.2"]
        NODE_C["🖥️ 节点 C<br/>IP: 10.1.0.3"]
    end

    NODE_A <-->|"P2P 连接"| NODE_B
    NODE_B <-->|"P2P 连接"| NODE_C
    NODE_A <-->|"P2P 连接"| NODE_C

    %% 样式定义
    classDef nodeStyle fill:#E3F2FD,stroke:#1976D2,stroke-width:2px,color:#1565C0

    class NODE_A,NODE_B,NODE_C nodeStyle
```

### 5.3 混合部署（VPN + 服务暴露）

```mermaid
flowchart LR
    subgraph NODE_A["🖥️ 节点 A"]
        direction TB
        VPN_A["🔐 VPN 接口<br/>IP: 10.1.0.1"]
        PROXY_A["🔄 反向代理服务<br/>Reverse Proxy"]
    end

    subgraph NODE_B["🖥️ 节点 B"]
        direction TB
        TCP_B["🔌 TCP 服务<br/>Port: 8080"]
        PROXY_B["🔄 代理服务<br/>Proxy Service"]
    end

    VPN_A -->|"本地网络"| PROXY_A
    TCP_B -->|"本地服务"| PROXY_B
    PROXY_A <-->|"P2P 隧道"| PROXY_B

    %% 样式定义
    classDef nodeStyle fill:#E3F2FD,stroke:#1976D2,stroke-width:2px,color:#1565C0
    classDef serviceStyle fill:#FFF3E0,stroke:#F57C00,stroke-width:2px,color:#E65100

    class VPN_A,PROXY_A,TCP_B,PROXY_B serviceStyle
```

## 6. 安全架构

### 6.1 网络安全

- **TLS 加密**：所有 P2P 连接使用 TLS 加密
- **令牌认证**：通过共享密钥验证网络成员
- **信任区域**：可选的 ECDSA 认证机制

### 6.2 数据安全

- **区块链验证**：所有账本数据通过哈希验证
- **数据加密**：支持 AES 加密存储
- **完整性检查**：区块哈希确保数据完整性

### 6.3 访问控制

- **白名单/黑名单**：控制对等节点连接
- **连接门控**：限制连接数和速率
- **资源限制**：防止资源耗尽攻击

## 7. 性能考虑

### 7.1 网络性能

- **多路复用**：支持多路复用的流连接
- **连接池**：复用 P2P 连接减少开销
- **流管理**：智能流连接管理

### 7.2 存储性能

- **内存缓存**：常用数据内存缓存
- **LRU 缓存**：DNS 记录 LRU 缓存
- **批量操作**：支持批量账本操作

### 7.3 资源优化

- **低配置模式**：减少资源使用
- **连接限制**：控制最大连接数
- **带宽管理**：可选的带宽限制

## 8. 可靠性设计

### 8.1 故障恢复

- **自动重连**：连接断开自动重连
- **状态同步**：节点重新加入自动同步状态
- **数据持久化**：支持磁盘持久化账本

### 8.2 容错机制

- **冗余路由**：DHT 提供冗余路由
- **多路径**：支持多路径数据传输
- **备份节点**：引导节点列表提供备份

## 9. 扩展性设计

### 9.1 水平扩展

- **无中心节点**：节点数量无限制
- **自动发现**：新节点自动加入网络
- **负载均衡**：DHT 自动负载均衡

### 9.2 垂直扩展

- **并发控制**：可配置并发连接数
- **资源调整**：动态调整资源分配
- **性能优化**：支持性能调优

## 10. 监控和运维

### 10.1 监控指标

- **连接统计**：节点连接数和状态
- **带宽使用**：上传/下载带宽统计
- **账本状态**：区块链高度和大小
- **服务状态**：各服务运行状态

### 10.2 日志记录

- **结构化日志**：使用 zap 结构化日志
- **日志级别**：支持多级别日志
- **日志轮转**：支持日志文件轮转

### 10.3 健康检查

- **接口检查**：VPN 接口状态检查
- **连接检查**：P2P 连接状态检查
- **服务检查**：各服务健康状态检查

## 11. 总结

EdgeVPN 采用现代化的去中心化架构设计，基于 libp2p 提供强大的 P2P 网络能力。通过分层架构、模块化设计和完善的机制，实现了安全、可靠、可扩展的去中心化网络解决方案。系统设计充分考虑了易用性、性能和可维护性，为用户提供了灵活的网络构建工具。

# EdgeVPN 接口定义

## 1. 概述

EdgeVPN 提供了完整的 REST API 接口，用于管理和监控 P2P 网络。本文档详细说明所有 API 接口的路径、请求方法、参数说明、返回格式及错误码定义。

## 2. API 基础信息

### 2.1 基础 URL

```
http://localhost:8080
```

### 2.2 认证方式

当前版本无需认证，后续版本将支持基于令牌的认证。

### 2.3 数据格式

- **请求格式**：JSON
- **响应格式**：JSON
- **字符编码**：UTF-8

### 2.4 通用响应格式

```json
{
  "code": 0,
  "message": "success",
  "data": {}
}
```

### 2.5 通用错误码

| 错误码 | 说明 |
|--------|------|
| 0 | 成功 |
| 400 | 请求参数错误 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

## 3. API 接口列表

### 3.1 机器管理接口

#### 3.1.1 获取机器列表

**接口路径**：`GET /api/machines`

**接口描述**：获取网络中所有机器的信息

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "peer_id": "QmXxx...",
      "ip": "10.1.0.1",
      "hostname": "node1",
      "timestamp": "2026-02-13T10:00:00Z"
    },
    {
      "peer_id": "QmYyy...",
      "ip": "10.1.0.2",
      "hostname": "node2",
      "timestamp": "2026-02-13T10:00:00Z"
    }
  ]
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| peer_id | string | 节点 PeerID |
| ip | string | VPN IP 地址 |
| hostname | string | 主机名 |
| timestamp | string | 最后更新时间 |

### 3.2 用户管理接口

#### 3.2.1 获取用户列表

**接口路径**：`GET /api/users`

**接口描述**：获取网络中所有用户的信息

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "peer_id": "QmXxx...",
      "username": "user1",
      "timestamp": "2026-02-13T10:00:00Z"
    },
    {
      "peer_id": "QmYyy...",
      "username": "user2",
      "timestamp": "2026-02-13T10:00:00Z"
    }
  ]
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| peer_id | string | 节点 PeerID |
| username | string | 用户名 |
| timestamp | string | 最后更新时间 |

### 3.3 服务管理接口

#### 3.3.1 获取服务列表

**接口路径**：`GET /api/services`

**接口描述**：获取网络中所有注册的服务

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "peer_id": "QmXxx...",
      "name": "web-service",
      "address": "10.1.0.1:8080",
      "timestamp": "2026-02-13T10:00:00Z"
    },
    {
      "peer_id": "QmYyy...",
      "name": "api-service",
      "address": "10.1.0.2:9000",
      "timestamp": "2026-02-13T10:00:00Z"
    }
  ]
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| peer_id | string | 服务提供者 PeerID |
| name | string | 服务名称 |
| address | string | 服务地址 |
| timestamp | string | 最后更新时间 |

### 3.4 区块链接口

#### 3.4.1 获取区块链信息

**接口路径**：`GET /api/blockchain`

**接口描述**：获取区块链的详细信息

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "height": 100,
    "blocks": [
      {
        "index": 0,
        "timestamp": "2026-02-13T10:00:00Z",
        "hash": "abc123...",
        "prev_hash": "",
        "storage": {
          "users": {
            "QmXxx...": {
              "username": "user1"
            }
          }
        }
      }
    ]
  }
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| height | int | 区块链高度 |
| blocks | array | 区块列表 |
| index | int | 区块索引 |
| timestamp | string | 区块时间戳 |
| hash | string | 区块哈希 |
| prev_hash | string | 前一区块哈希 |
| storage | object | 存储数据 |

### 3.5 账本接口

#### 3.5.1 获取账本数据

**接口路径**：`GET /api/ledger`

**接口描述**：获取当前账本的所有数据

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "users": {
      "QmXxx...": {
        "username": "user1",
        "timestamp": "2026-02-13T10:00:00Z"
      }
    },
    "machines": {
      "QmXxx...": {
        "ip": "10.1.0.1",
        "hostname": "node1",
        "timestamp": "2026-02-13T10:00:00Z"
      }
    },
    "services": {
      "web-service": {
        "peer_id": "QmXxx...",
        "address": "10.1.0.1:8080",
        "timestamp": "2026-02-13T10:00:00Z"
      }
    },
    "dns": {
      "example\\.com": {
        "type": "A",
        "value": "10.1.0.1",
        "timestamp": "2026-02-13T10:00:00Z"
      }
    }
  }
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| users | object | 用户数据 |
| machines | object | 机器数据 |
| services | object | 服务数据 |
| dns | object | DNS 数据 |

### 3.6 摘要接口

#### 3.6.1 获取网络摘要

**接口路径**：`GET /api/summary`

**接口描述**：获取网络状态的摘要信息

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "total_peers": 5,
    "total_services": 3,
    "total_files": 2,
    "blockchain_height": 100,
    "network_uptime": "2h30m",
    "last_block_time": "2026-02-13T10:00:00Z"
  }
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| total_peers | int | 总节点数 |
| total_services | int | 总服务数 |
| total_files | int | 总文件数 |
| blockchain_height | int | 区块链高度 |
| network_uptime | string | 网络运行时间 |
| last_block_time | string | 最后区块时间 |

### 3.7 文件管理接口

#### 3.7.1 获取文件列表

**接口路径**：`GET /api/files`

**接口描述**：获取网络中共享的文件列表

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "peer_id": "QmXxx...",
      "name": "file1.txt",
      "size": 1024,
      "timestamp": "2026-02-13T10:00:00Z"
    },
    {
      "peer_id": "QmYyy...",
      "name": "file2.pdf",
      "size": 2048,
      "timestamp": "2026-02-13T10:00:00Z"
    }
  ]
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| peer_id | string | 文件提供者 PeerID |
| name | string | 文件名称 |
| size | int | 文件大小（字节） |
| timestamp | string | 最后更新时间 |

### 3.8 节点管理接口

#### 3.8.1 获取节点列表

**接口路径**：`GET /api/nodes`

**接口描述**：获取网络中所有连接的节点

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "peer_id": "QmXxx...",
      "addresses": [
        "/ip4/192.168.1.1/tcp/4001/p2p/QmXxx..."
      ],
      "connected": true,
      "latency": "50ms"
    },
    {
      "peer_id": "QmYyy...",
      "addresses": [
        "/ip4/192.168.1.2/tcp/4001/p2p/QmYyy..."
      ],
      "connected": true,
      "latency": "30ms"
    }
  ]
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| peer_id | string | 节点 PeerID |
| addresses | array | 节点地址列表 |
| connected | bool | 是否已连接 |
| latency | string | 连接延迟 |

### 3.9 DNS 接口

#### 3.9.1 获取 DNS 记录

**接口路径**：`GET /api/dns`

**接口描述**：获取网络中的 DNS 记录

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "name": "example.com",
      "type": "A",
      "value": "10.1.0.1",
      "ttl": 300,
      "timestamp": "2026-02-13T10:00:00Z"
    },
    {
      "name": "api.example.com",
      "type": "A",
      "value": "10.1.0.2",
      "ttl": 300,
      "timestamp": "2026-02-13T10:00:00Z"
    }
  ]
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| name | string | 域名 |
| type | string | 记录类型 (A, AAAA, CNAME 等) |
| value | string | 记录值 |
| ttl | int | 生存时间（秒） |
| timestamp | string | 最后更新时间 |

#### 3.9.2 添加 DNS 记录

**接口路径**：`POST /api/dns`

**接口描述**：添加新的 DNS 记录

**请求参数**：

```json
{
  "name": "new.example.com",
  "type": "A",
  "value": "10.1.0.3",
  "ttl": 300
}
```

**响应示例**：

```json
{
  "code": 0,
  "message": "DNS record added successfully",
  "data": null
}
```

**请求参数说明**：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| name | string | 是 | 域名 |
| type | string | 是 | 记录类型 |
| value | string | 是 | 记录值 |
| ttl | int | 否 | 生存时间（默认 300） |

### 3.10 指标接口

#### 3.10.1 获取性能指标

**接口路径**：`GET /api/metrics`

**接口描述**：获取节点的性能指标

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "bandwidth": {
      "in": 1024000,
      "out": 512000
    },
    "connections": {
      "total": 10,
      "active": 8
    },
    "memory": {
      "alloc": 10485760,
      "sys": 20971520
    },
    "goroutines": 50
  }
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| bandwidth | object | 带宽统计 |
| bandwidth.in | int | 入站流量（字节） |
| bandwidth.out | int | 出站流量（字节） |
| connections | object | 连接统计 |
| connections.total | int | 总连接数 |
| connections.active | int | 活跃连接数 |
| memory | object | 内存统计 |
| memory.alloc | int | 已分配内存（字节） |
| memory.sys | int | 系统内存（字节） |
| goroutines | int | Goroutine 数量 |

### 3.11 对等存储接口

#### 3.11.1 获取对等存储信息

**接口路径**：`GET /api/peerstore`

**接口描述**：获取对等节点的存储信息

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": [
    {
      "peer_id": "QmXxx...",
      "protocols": [
        "/edgevpn/0.1",
        "/edgevpn/service/0.1"
      ],
      "addrs": [
        "/ip4/192.168.1.1/tcp/4001"
      ],
      "last_seen": "2026-02-13T10:00:00Z"
    }
  ]
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| peer_id | string | 节点 PeerID |
| protocols | array | 支持的协议列表 |
| addrs | array | 节点地址列表 |
| last_seen | string | 最后见到时间 |

### 3.12 对等网关接口

#### 3.12.1 获取对等网关状态

**接口路径**：`GET /api/peergate`

**接口描述**：获取对等网关的状态信息

**请求参数**：无

**响应示例**：

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "enabled": true,
    "trusted_peers": [
      "QmXxx...",
      "QmYyy..."
    ],
    "blocked_peers": [],
    "auth_providers": [
      "ecdsa"
    ]
  }
}
```

**数据字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| enabled | bool | 是否启用 |
| trusted_peers | array | 受信任的节点列表 |
| blocked_peers | array | 被阻止的节点列表 |
| auth_providers | array | 认证提供者列表 |

## 4. 错误码定义

### 4.1 HTTP 状态码

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 4.2 业务错误码

| 错误码 | 说明 |
|--------|------|
| 1001 | 节点未连接 |
| 1002 | 账本同步失败 |
| 1003 | 服务注册失败 |
| 1004 | DNS 记录已存在 |
| 1005 | 文件不存在 |
| 1006 | 认证失败 |
| 1007 | 权限不足 |

### 4.3 错误响应格式

```json
{
  "code": 1001,
  "message": "Node not connected",
  "data": null
}
```

## 5. 使用示例

### 5.1 使用 cURL

```bash
# 获取机器列表
curl http://localhost:8080/api/machines

# 获取账本数据
curl http://localhost:8080/api/ledger

# 添加 DNS 记录
curl -X POST http://localhost:8080/api/dns \
  -H "Content-Type: application/json" \
  -d '{
    "name": "example.com",
    "type": "A",
    "value": "10.1.0.1",
    "ttl": 300
  }'
```

### 5.2 使用 Python

```python
import requests

# 获取机器列表
response = requests.get('http://localhost:8080/api/machines')
machines = response.json()['data']

# 获取账本数据
response = requests.get('http://localhost:8080/api/ledger')
ledger = response.json()['data']

# 添加 DNS 记录
dns_record = {
    'name': 'example.com',
    'type': 'A',
    'value': '10.1.0.1',
    'ttl': 300
}
response = requests.post('http://localhost:8080/api/dns', json=dns_record)
```

### 5.3 使用 Go

```go
package main

import (
    "encoding/json"
    "net/http"
)

func main() {
    // 获取机器列表
    resp, err := http.Get("http://localhost:8080/api/machines")
    if err != nil {
        panic(err)
    }
    defer resp.Body.Close()

    var result struct {
        Code    int         `json:"code"`
        Message string       `json:"message"`
        Data    []Machine    `json:"data"`
    }
    json.NewDecoder(resp.Body).Decode(&result)

    // 添加 DNS 记录
    dnsRecord := map[string]interface{}{
        "name":  "example.com",
        "type":  "A",
        "value": "10.1.0.1",
        "ttl":   300,
    }
    data, _ := json.Marshal(dnsRecord)
    resp, err = http.Post(
        "http://localhost:8080/api/dns",
        "application/json",
        bytes.NewReader(data),
    )
}
```

## 6. 最佳实践

### 6.1 错误处理

始终检查响应中的 `code` 字段，确保请求成功后再处理数据。

### 6.2 缓存策略

对于不常变化的数据（如机器列表、服务列表），可以实现客户端缓存。

### 6.3 轮询间隔

建议使用合理的轮询间隔（如 5-10 秒），避免频繁请求。

### 6.4 超时设置

为所有 API 请求设置合理的超时时间（如 30 秒）。

## 7. 版本控制

当前 API 版本：v1

API 版本通过 URL 路径或请求头指定，未来版本将支持版本化。

## 8. 总结

EdgeVPN 提供了完整的 REST API 接口，覆盖了网络管理的各个方面。开发者可以通过这些接口实现网络监控、服务管理、DNS 配置等功能。API 设计遵循 RESTful 原则，易于理解和使用。

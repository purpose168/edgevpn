# EdgeVPN 常见问题解决方案

## 1. 概述

本文档整理了 EdgeVPN 在开发、测试、部署过程中常见问题的诊断方法和解决策略。通过本文档，开发者可以快速定位和解决问题，提高工作效率。

## 2. 安装和配置问题

### 2.1 安装问题

#### 问题 1：Go 版本不兼容

**症状**：
```
go: cannot find main module
go: go.mod file not found in current directory
```

**诊断**：
```bash
# 检查 Go 版本
go version

# 检查 go.mod 文件
ls -la go.mod
```

**解决方案**：
```bash
# 1. 安装正确的 Go 版本（1.24.6+）
# 访问 https://golang.org/dl/ 下载

# 2. 设置 GOPATH 和 GOROOT
export GOPATH=$HOME/go
export GOROOT=/usr/local/go
export PATH=$PATH:$GOPATH/bin:$GOROOT/bin

# 3. 验证安装
go version
```

#### 问题 2：依赖下载失败

**症状**：
```
go: github.com/purpose168/edgevpn@latest: reading github.com/purpose168/edgevpn/go.mod at revision latest: unknown revision latest
```

**诊断**：
```bash
# 检查网络连接
ping github.com

# 检查代理设置
echo $GOPROXY
```

**解决方案**：
```bash
# 1. 设置 Go 代理
export GOPROXY=https://goproxy.cn,direct

# 2. 或使用阿里云代理
export GOPROXY=https://mirrors.aliyun.com/goproxy/,direct

# 3. 清理缓存
go clean -modcache

# 4. 重新下载依赖
go mod download
```

#### 问题 3：编译错误

**症状**：
```
# github.com/purpose168/edgevpn/pkg/node
./node.go:123: undefined: SomeFunction
```

**诊断**：
```bash
# 检查代码语法
go vet ./...

# 检查依赖
go mod verify
```

**解决方案**：
```bash
# 1. 更新依赖
go get -u ./...

# 2. 整理依赖
go mod tidy

# 3. 重新编译
go build
```

### 2.2 配置问题

#### 问题 4：配置文件格式错误

**症状**：
```
Error: invalid configuration: yaml: unmarshal errors
```

**诊断**：
```bash
# 验证 YAML 格式
python -c "import yaml; yaml.safe_load(open('config.yaml'))"

# 或使用在线工具
# https://www.yamllint.com/
```

**解决方案**：
```bash
# 1. 检查缩进（YAML 使用空格，不使用 tab）
# 2. 检查冒号后面是否有空格
# 3. 检查引号是否正确

# 示例正确格式
network:
  token: "your_token_here"
  address: "10.1.0.1/24"

# 4. 重新生成配置
edgevpn -g > config.yaml
```

#### 问题 5：令牌无效

**症状**：
```
Error: invalid token: base64 decode error
```

**诊断**：
```bash
# 检查令牌格式
echo $EDGEVPNTOKEN | base64 -d
```

**解决方案**：
```bash
# 1. 生成新令牌
EDGEVPNTOKEN=$(edgevpn -g -b)
echo $EDGEVPNTOKEN

# 2. 验证令牌
edgevpn --token $EDGEVPNTOKEN

# 3. 或使用配置文件
edgevpn --config config.yaml
```

#### 问题 6：环境变量未生效

**症状**：
```
Error: missing required environment variable: EDGEVPNTOKEN
```

**诊断**：
```bash
# 检查环境变量
echo $EDGEVPNTOKEN

# 检查进程环境
ps aux | grep edgevpn
```

**解决方案**：
```bash
# 1. 设置环境变量
export EDGEVPNTOKEN="your_token_here"

# 2. 或在命令行中设置
EDGEVPNTOKEN="your_token_here" edgevpn

# 3. 或使用 .env 文件
echo 'EDGEVPNTOKEN="your_token_here"' > .env
source .env
edgevpn
```

## 3. 网络连接问题

### 3.1 P2P 连接问题

#### 问题 7：无法发现其他节点

**症状**：
```
No peers found in the network
```

**诊断**：
```bash
# 检查节点状态
curl http://localhost:8080/api/summary

# 检查对等节点
curl http://localhost:8080/api/nodes

# 检查日志
journalctl -u edgevpn -f
```

**解决方案**：
```bash
# 1. 检查网络连接
ping -c 5 8.8.8.8

# 2. 检查防火墙
sudo ufw status
sudo iptables -L

# 3. 开放必要端口
sudo ufw allow 4001/tcp
sudo ufw allow 4001/udp

# 4. 检查 NAT
curl ifconfig.me

# 5. 使用中继节点
edgevpn --relay
```

#### 问题 8：连接超时

**症状**：
```
Error: connection timeout
```

**诊断**：
```bash
# 检查网络延迟
ping -c 5 <peer-ip>

# 检查端口连通性
telnet <peer-ip> 4001

# 检查路由
traceroute <peer-ip>
```

**解决方案**：
```bash
# 1. 增加超时时间
export TIMEOUT=60s

# 2. 使用中继
edgevpn --relay

# 3. 检查 DNS
nslookup <peer-domain>

# 4. 使用静态 IP
edgevpn --static-ip <peer-ip>
```

#### 问题 9：NAT 穿透失败

**症状**：
```
Error: NAT traversal failed
```

**诊断**：
```bash
# 检查 NAT 类型
curl https://api.ipify.org?format=json

# 检查 STUN 服务器
stunclient stun.l.google.com:19302
```

**解决方案**：
```bash
# 1. 配置 STUN 服务器
edgevpn --stun stun.l.google.com:19302

# 2. 使用中继
edgevpn --relay

# 3. 配置 UPnP
edgevpn --upnp

# 4. 使用端口转发
# 在路由器上配置端口转发规则
```

### 3.2 VPN 连接问题

#### 问题 10：无法创建 VPN 接口

**症状**：
```
Error: failed to create TUN device: operation not permitted
```

**诊断**：
```bash
# 检查权限
ls -l /dev/net/tun

# 检查用户组
groups
```

**解决方案**：
```bash
# 1. 添加 CAP_NET_ADMIN 权限
sudo setcap cap_net_admin+ep /usr/local/bin/edgevpn

# 2. 或使用 sudo 运行
sudo edgevpn

# 3. 或将用户添加到相关组
sudo usermod -a -G netdev $USER
```

#### 问题 11：VPN 接口无法获取 IP

**症状**：
```
Error: failed to assign IP address
```

**诊断**：
```bash
# 检查接口状态
ifconfig edgevpn0

# 检查 IP 冲突
arp -n | grep <ip-address>
```

**解决方案**：
```bash
# 1. 检查配置
cat config.yaml | grep address

# 2. 更改 IP 地址
edgevpn --address 10.2.0.1/24

# 3. 或使用 DHCP
edgevpn --dhcp
```

#### 问题 12：VPN 数据包丢失

**症状**：
```
High packet loss rate
```

**诊断**：
```bash
# 检查网络质量
ping -c 100 <peer-ip>

# 检查接口统计
ifconfig edgevpn0

# 检查路由表
route -n
```

**解决方案**：
```bash
# 1. 调整 MTU
edgevpn --interface-mtu 1400

# 2. 检查网络拥塞
netstat -i

# 3. 优化路由
sudo route add -net 10.0.0.0/8 dev edgevpn0

# 4. 检查防火墙规则
sudo iptables -L -v
```

## 4. 性能问题

### 4.1 内存问题

#### 问题 13：内存泄漏

**症状**：
```
Memory usage keeps increasing
```

**诊断**：
```bash
# 检查内存使用
ps aux | grep edgevpn

# 使用 pprof 分析
go tool pprof http://localhost:8080/debug/pprof/heap
```

**解决方案**：
```bash
# 1. 重启服务
sudo systemctl restart edgevpn

# 2. 限制内存使用
export GOMEMLIMIT=512MiB

# 3. 检查代码中的资源泄漏
# 使用 go vet 和 race detector
go test -race ./...
```

#### 问题 14：内存不足

**症状**：
```
Error: out of memory
```

**诊断**：
```bash
# 检查系统内存
free -h

# 检查进程内存
ps aux --sort=-%mem | head -20
```

**解决方案**：
```bash
# 1. 增加系统内存
# 或增加交换空间
sudo dd if=/dev/zero of=/swapfile bs=1M count=1024
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 2. 限制连接数
export MAXCONNECTIONS=50

# 3. 优化配置
edgevpn --max-connections 50
```

### 4.2 CPU 问题

#### 问题 15：CPU 使用率过高

**症状**：
```
High CPU usage
```

**诊断**：
```bash
# 检查 CPU 使用
top -p $(pgrep edgevpn)

# 使用 pprof 分析
go tool pprof http://localhost:8080/debug/pprof/profile
```

**解决方案**：
```bash
# 1. 检查是否有死循环
# 使用 pprof 分析 CPU profile

# 2. 限制并发数
export CONCURRENCY=2

# 3. 优化算法
# 检查代码中的性能瓶颈

# 4. 使用性能分析工具
go tool pprof -http=:8080 cpu.prof
```

#### 问题 16：响应缓慢

**症状**：
```
Slow response time
```

**诊断**：
```bash
# 检查网络延迟
ping -c 10 <peer-ip>

# 检查 API 响应
time curl http://localhost:8080/api/summary
```

**解决方案**：
```bash
# 1. 检查网络质量
mtr <peer-ip>

# 2. 优化配置
edgevpn --max-connections 100

# 3. 使用缓存
# 在应用层实现缓存

# 4. 负载均衡
# 使用多个节点分担负载
```

## 5. 区块链问题

### 5.1 同步问题

#### 问题 17：区块链同步失败

**症状**：
```
Error: blockchain sync failed
```

**诊断**：
```bash
# 检查区块链状态
curl http://localhost:8080/api/blockchain

# 检查日志
journalctl -u edgevpn -f | grep blockchain
```

**解决方案**：
```bash
# 1. 重启节点
sudo systemctl restart edgevpn

# 2. 清理本地区块链
rm -rf ~/.edgevpn/blockchain

# 3. 重新同步
edgevpn --resync
```

#### 问题 18：区块链分叉

**症状**：
```
Blockchain fork detected
```

**诊断**：
```bash
# 检查区块链高度
curl http://localhost:8080/api/blockchain | jq '.data.height'

# 检查区块哈希
curl http://localhost:8080/api/blockchain | jq '.data.hash'
```

**解决方案**：
```bash
# 1. 等待共识完成
# 分叉通常会自动解决

# 2. 如果长时间未解决，重新同步
edgevpn --resync

# 3. 检查网络连接
# 确保连接到大多数节点
```

### 5.2 存储问题

#### 问题 19：区块链数据损坏

**症状**：
```
Error: corrupted blockchain data
```

**诊断**：
```bash
# 检查区块链文件
ls -lh ~/.edgevpn/blockchain/

# 验证数据完整性
sha256sum ~/.edgevpn/blockchain/*.db
```

**解决方案**：
```bash
# 1. 备份数据
cp -r ~/.edgevpn/blockchain ~/.edgevpn/blockchain.backup

# 2. 删除损坏的数据
rm -rf ~/.edgevpn/blockchain

# 3. 重新同步
edgevpn --resync
```

#### 问题 20：存储空间不足

**症状**：
```
Error: no space left on device
```

**诊断**：
```bash
# 检查磁盘空间
df -h

# 检查区块链大小
du -sh ~/.edgevpn/blockchain
```

**解决方案**：
```bash
# 1. 清理旧数据
edgevpn --prune

# 2. 更改存储位置
export EDGEVPN_DATA=/path/to/larger/disk

# 3. 增加磁盘空间
# 或使用外部存储
```

## 6. DNS 问题

### 6.1 解析问题

#### 问题 21：DNS 解析失败

**症状**：
```
Error: DNS resolution failed
```

**诊断**：
```bash
# 检查 DNS 配置
cat /etc/resolv.conf

# 测试 DNS 解析
nslookup example.com
dig example.com
```

**解决方案**：
```bash
# 1. 检查 DNS 服务
systemctl status systemd-resolved

# 2. 更改 DNS 服务器
echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf

# 3. 使用 EdgeVPN DNS
edgevpn --dns :53 --forwarder
```

#### 问题 22：DNS 缓存问题

**症状**：
```
DNS returns stale results
```

**诊断**：
```bash
# 检查 DNS 缓存
systemd-resolve --statistics

# 检查 DNS 记录
curl http://localhost:8080/api/dns
```

**解决方案**：
```bash
# 1. 清理 DNS 缓存
sudo systemd-resolve --flush-caches

# 2. 重启 DNS 服务
sudo systemctl restart systemd-resolved

# 3. 减少 TTL
edgevpn --dns-ttl 60
```

### 6.2 转发问题

#### 问题 23：DNS 转发失败

**症状**：
```
Error: DNS forward failed
```

**诊断**：
```bash
# 检查转发配置
cat config.yaml | grep forward

# 测试转发 DNS
dig @8.8.8.8 example.com
```

**解决方案**：
```bash
# 1. 检查上游 DNS
ping -c 5 8.8.8.8

# 2. 更改转发 DNS
edgevpn --forward 1.1.1.1:53

# 3. 禁用转发
edgevpn --no-forwarder
```

## 7. API 问题

### 7.1 连接问题

#### 问题 24：API 无法访问

**症状**：
```
Error: connection refused
```

**诊断**：
```bash
# 检查 API 状态
curl http://localhost:8080/api/summary

# 检查端口监听
netstat -tlnp | grep 8080
```

**解决方案**：
```bash
# 1. 启用 API
edgevpn --api

# 2. 检查监听地址
edgevpn --api-listen 0.0.0.0:8080

# 3. 检查防火墙
sudo ufw allow 8080/tcp
```

#### 问题 25：API 认证失败

**症状**：
```
Error: unauthorized
```

**诊断**：
```bash
# 检查认证配置
cat config.yaml | grep auth

# 测试 API
curl -H "Authorization: Bearer <token>" http://localhost:8080/api/summary
```

**解决方案**：
```bash
# 1. 设置 API 密钥
export API_KEY="your_api_key"

# 2. 使用正确的认证
curl -H "Authorization: Bearer $API_KEY" http://localhost:8080/api/summary

# 3. 或禁用认证（仅用于开发）
edgevpn --no-auth
```

### 7.2 性能问题

#### 问题 26：API 响应慢

**症状**：
```
Slow API response
```

**诊断**：
```bash
# 测试 API 响应时间
time curl http://localhost:8080/api/summary

# 检查系统负载
top
```

**解决方案**：
```bash
# 1. 优化查询
# 使用分页和过滤

# 2. 增加缓存
# 在应用层实现缓存

# 3. 负载均衡
# 使用多个 API 实例
```

## 8. Docker 问题

### 8.1 构建问题

#### 问题 27：Docker 构建失败

**症状**：
```
Error: failed to build Docker image
```

**诊断**：
```bash
# 检查 Docker 状态
docker ps

# 查看构建日志
docker build -t edgevpn:latest .
```

**解决方案**：
```bash
# 1. 清理 Docker 缓存
docker system prune -a

# 2. 检查 Dockerfile
# 确保所有命令都正确

# 3. 使用多阶段构建
# 优化镜像大小
```

#### 问题 28：Docker 镜像过大

**症状**：
```
Docker image size is too large
```

**诊断**：
```bash
# 检查镜像大小
docker images edgevpn

# 分析镜像层
docker history edgevpn:latest
```

**解决方案**：
```bash
# 1. 使用多阶段构建
# 在 Dockerfile 中使用多阶段构建

# 2. 使用 alpine 基础镜像
FROM alpine:latest

# 3. 清理不必要的文件
# 在构建过程中删除临时文件
```

### 8.2 运行问题

#### 问题 29：容器无法启动

**症状**：
```
Error: container failed to start
```

**诊断**：
```bash
# 查看容器日志
docker logs edgevpn

# 检查容器状态
docker ps -a
```

**解决方案**：
```bash
# 1. 检查配置
# 确保 docker-compose.yml 配置正确

# 2. 检查权限
# 确保有足够的权限

# 3. 检查网络
# 确保网络配置正确
```

#### 问题 30：容器网络问题

**症状**：
```
Error: container network unreachable
```

**诊断**：
```bash
# 检查容器网络
docker network ls
docker network inspect edgevpn-test

# 检查容器连接
docker exec edgevpn ping -c 5 8.8.8.8
```

**解决方案**：
```bash
# 1. 使用 host 网络模式
docker run --network host edgevpn:latest

# 2. 配置端口映射
docker run -p 4001:4001 -p 8080:8080 edgevpn:latest

# 3. 检查防火墙
# 确保端口开放
```

## 9. 日志和调试

### 9.1 日志问题

#### 问题 31：日志不输出

**症状**：
```
No log output
```

**诊断**：
```bash
# 检查日志级别
cat config.yaml | grep loglevel

# 检查日志文件
ls -lh ~/.edgevpn/logs/
```

**解决方案**：
```bash
# 1. 启用调试日志
export LOGLEVEL=debug
edgevpn --debug

# 2. 检查日志输出
journalctl -u edgevpn -f

# 3. 重定向日志
edgevpn 2>&1 | tee edgevpn.log
```

#### 问题 32：日志过多

**症状**：
```
Too much log output
```

**诊断**：
```bash
# 检查日志大小
du -sh ~/.edgevpn/logs/

# 检查日志级别
cat config.yaml | grep loglevel
```

**解决方案**：
```bash
# 1. 降低日志级别
export LOGLEVEL=warn

# 2. 配置日志轮转
# 使用 logrotate

# 3. 清理旧日志
find ~/.edgevpn/logs/ -name "*.log" -mtime +7 -delete
```

### 9.2 调试问题

#### 问题 33：无法调试

**症状**：
```
Cannot attach debugger
```

**诊断**：
```bash
# 检查进程
ps aux | grep edgevpn

# 检查端口
netstat -tlnp | grep edgevpn
```

**解决方案**：
```bash
# 1. 使用 Delve 调试器
dlv debug ./main.go

# 2. 启用 pprof
edgevpn --pprof

# 3. 使用 race detector
go test -race ./...
```

## 10. 安全问题

### 10.1 认证问题

#### 问题 34：认证失败

**症状**：
```
Error: authentication failed
```

**诊断**：
```bash
# 检查令牌
echo $EDGEVPNTOKEN

# 检查配置
cat config.yaml | grep token
```

**解决方案**：
```bash
# 1. 重新生成令牌
EDGEVPNTOKEN=$(edgevpn -g -b)

# 2. 检查令牌格式
# 确保使用 base64 编码

# 3. 检查信任区域
# 确保节点在信任区域内
```

#### 问题 35：权限不足

**症状**：
```
Error: permission denied
```

**诊断**：
```bash
# 检查用户权限
id

# 检查文件权限
ls -l ~/.edgevpn/
```

**解决方案**：
```bash
# 1. 修改文件权限
chmod 600 ~/.edgevpn/config.yaml

# 2. 使用正确的用户
# 确保使用正确的用户运行

# 3. 检查 sudo 配置
# 确保有必要的 sudo 权限
```

### 10.2 加密问题

#### 问题 36：加密失败

**症状**：
```
Error: encryption failed
```

**诊断**：
```bash
# 检查加密配置
cat config.yaml | grep encryption

# 检查密钥
ls -l ~/.edgevpn/keys/
```

**解决方案**：
```bash
# 1. 重新生成密钥
edgevpn --generate-keys

# 2. 检查加密算法
# 确保使用支持的加密算法

# 3. 检查密钥权限
chmod 600 ~/.edgevpn/keys/*
```

## 11. 故障排查工具

### 11.1 诊断工具

#### 系统诊断

```bash
# 系统信息
uname -a

# 内存使用
free -h

# 磁盘使用
df -h

# CPU 使用
top

# 网络连接
netstat -tlnp

# 进程信息
ps aux | grep edgevpn
```

#### 网络诊断

```bash
# 网络连通性
ping -c 5 8.8.8.8

# DNS 解析
nslookup example.com

# 端口扫描
nmap -p 4001 <peer-ip>

# 路由跟踪
traceroute <peer-ip>

# 网络延迟
mtr <peer-ip>
```

#### 应用诊断

```bash
# API 状态
curl http://localhost:8080/api/summary

# 节点状态
curl http://localhost:8080/api/nodes

# 区块链状态
curl http://localhost:8080/api/blockchain

# 日志查看
journalctl -u edgevpn -f
```

### 11.2 性能分析

#### CPU 分析

```bash
# 生成 CPU profile
curl http://localhost:8080/debug/pprof/profile?seconds=30 > cpu.prof

# 分析 CPU profile
go tool pprof cpu.prof

# 生成火焰图
go tool pprof -http=:8080 cpu.prof
```

#### 内存分析

```bash
# 生成内存 profile
curl http://localhost:8080/debug/pprof/heap > heap.prof

# 分析内存 profile
go tool pprof heap.prof

# 生成内存分布图
go tool pprof -http=:8080 heap.prof
```

#### 协程分析

```bash
# 查看协程
curl http://localhost:8080/debug/pprof/goroutine

# 生成协程 profile
curl http://localhost:8080/debug/pprof/goroutine?debug=2 > goroutine.prof

# 分析协程
go tool pprof goroutine.prof
```

## 12. 获取帮助

### 12.1 社区支持

- **GitHub Issues**：https://github.com/purpose168/edgevpn/issues
- **GitHub Discussions**：https://github.com/purpose168/edgevpn/discussions
- **文档**：https://github.com/purpose168/edgevpn/tree/master/docs

### 12.2 报告问题

报告问题时，请提供以下信息：

1. **EdgeVPN 版本**
   ```bash
   edgevpn --version
   ```

2. **操作系统信息**
   ```bash
   uname -a
   ```

3. **配置信息**
   ```bash
   cat config.yaml
   ```

4. **日志信息**
   ```bash
   journalctl -u edgevpn -n 100
   ```

5. **错误信息**
   ```bash
   # 完整的错误堆栈
   ```

6. **复现步骤**
   - 详细描述如何复现问题

### 12.3 联系方式

- **Email**：purpose168@outlook.com
- **项目主页**：https://github.com/purpose168/edgevpn

## 13. 总结

本文档涵盖了 EdgeVPN 在开发、测试、部署过程中常见的问题和解决方案。遇到问题时，首先使用诊断工具定位问题，然后参考相应的解决方案。如果问题仍然存在，请寻求社区支持或报告问题。

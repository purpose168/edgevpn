#!/bin/bash
# =============================================================================
# 脚本名称：publish.sh
# 用途：发布 Hugo 站点到 GitHub Pages
# 作者：purpose168@outlook.com
# 创建日期：2026-02-13
# =============================================================================

# 设置错误时立即退出
# -e 选项：当任何命令返回非零状态码时，脚本立即退出
set -e

# 首先执行构建脚本，生成静态网站文件
# ROOT_DIR 是环境变量，表示项目根目录
"${ROOT_DIR}"/scripts/build.sh

# 删除 gh-pages 分支（如果存在）
# -D 选项：强制删除分支，即使有未合并的更改
# || true：如果分支不存在，忽略错误继续执行
git branch -D gh-pages || true

# 创建并切换到新的孤儿分支 gh-pages
# --orphan：创建一个没有提交历史的全新分支
# 孤儿分支用于 GitHub Pages 部署，保持提交历史干净
git checkout --orphan gh-pages

# 删除当前目录下的所有文件（保留 .git 目录）
# git rm：从 Git 仓库中删除文件
# -r：递归删除目录
# -f：强制删除，忽略警告
# .：当前目录
git rm -rf .

# 将构建生成的 public 目录中的所有文件复制到当前目录
# cp：复制命令
# -r：递归复制目录
# -f：强制覆盖，不提示确认
# -v：显示详细过程
cp -rfv public/* ./

# 删除 public 目录，因为文件已经复制到根目录
# -r：递归删除目录
# -f：强制删除，不提示确认
rm -rf public/

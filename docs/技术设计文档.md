# EdgeVPN 技术设计文档

## 目录

1. [项目概述](#1-项目概述)
2. [架构设计](#2-架构设计)
3. [模块说明](#3-模块说明)
4. [核心接口定义](#4-核心接口定义)
5. [数据流程](#5-数据流程)
6. [依赖关系](#6-依赖关系)
7. [部署指南](#7-部署指南)

---

## 1. 项目概述

### 1.1 项目简介

**EdgeVPN** 是一个基于 libp2p 构建的去中心化 VPN 解决方案。它利用 P2P 网络和区块链账本技术，实现了一个无需中央服务器的安全虚拟专用网络。

### 1.2 核心特性

| 特性 | 描述 |
|------|------|
| 去中心化 | 基于 libp2p 的 P2P 网络，无需中央服务器 |
| 安全加密 | 使用 AES-GCM 加密和 TOTP 动态密钥 |
| 区块链账本 | 分布式账本存储网络状态和路由信息 |
| NAT 穿透 | 支持 NAT 端口映射和中继连接 |
| 跨平台 | 支持 Linux、macOS、Windows、FreeBSD |
| 服务发现 | 支持 DHT 和 mDNS 两种发现机制 |
| DNS 服务 | 内置 P2P DNS 服务器和转发功能 |
| DHCP 服务 | 支持 P2P IP 地址协商 |

### 1.3 技术栈

| 技术 | 用途 |
|------|------|
| Go 1.24+ | 主要编程语言 |
| libp2p | P2P 网络框架 |
| GossipSub | 发布订阅消息系统 |
| Kademlia DHT | 分布式哈希表 |
| AES-GCM | 数据加密 |
| TOTP | 动态密钥生成 |
| WireGuard | 网络接口（Windows） |
| TUN/TAP | 虚拟网络接口 |

### 1.4 项目结构

```
edgevpn/
├── api/                    # API 服务模块
│   ├── client/            # API 客户端
│   │   └── service/       # 服务客户端实现
│   ├── generate/          # 代码生成工具
│   └── types/             # API 类型定义
├── cmd/                    # 命令行入口
│   ├── main.go            # 主程序入口
│   ├── api.go             # API 命令
│   ├── dns.go             # DNS 命令
│   ├── file.go            # 文件传输命令
│   ├── join.go            # 加入网络命令
│   ├── peergate.go        # 对等节点门控命令
│   ├── proxy.go           # 代理命令
│   ├── service.go         # 服务命令
│   └── util.go            # 工具函数
├── internal/               # 内部模块
│   └── version.go         # 版本信息
├── pkg/                    # 核心包
│   ├── blockchain/        # 区块链账本
│   ├── config/            # 配置管理
│   ├── crypto/            # 加密工具
│   ├── discovery/         # 节点发现
│   ├── hub/               # 消息中心
│   ├── logger/            # 日志系统
│   ├── node/              # 节点核心
│   ├── protocol/          # 协议定义
│   ├── services/          # 网络服务
│   ├── stream/            # 流管理
│   ├── trustzone/         # 信任区域
│   ├── types/             # 类型定义
│   ├── utils/             # 工具函数
│   └── vpn/               # VPN 核心
├── main.go                 # 程序入口
├── go.mod                  # Go 模块定义
├── Dockerfile              # Docker 构建文件
├── docker-compose.yml      # Docker Compose 配置
├── install.sh              # 安装脚本
└── .goreleaser.yml         # 发布配置
```

---

## 2. 架构设计

### 2.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           EdgeVPN 节点                               │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │
│  │   CLI 层    │  │   API 层    │  │  服务层     │  │  VPN 层     │ │
│  │  (cmd/)     │  │  (api/)     │  │ (services/) │  │  (vpn/)     │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘ │
│         │                │                │                │        │
│  ┌──────┴────────────────┴────────────────┴────────────────┴──────┐ │
│  │                        节点核心 (node/)                          │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │ │
│  │  │  配置管理    │  │  消息中心    │  │  流处理器    │          │ │
│  │  │  (config)    │  │   (hub)      │  │  (stream)    │          │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│         │                                                            │
│  ┌──────┴──────────────────────────────────────────────────────────┐│
│  │                     区块链账本 (blockchain/)                      ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          ││
│  │  │  区块存储    │  │  数据同步    │  │  状态管理    │          ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘          ││
│  └─────────────────────────────────────────────────────────────────┘│
│         │                                                            │
│  ┌──────┴──────────────────────────────────────────────────────────┐│
│  │                     libp2p 网络层                                ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          ││
│  │  │  DHT 发现    │  │  mDNS 发现   │  │  GossipSub   │          ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘          ││
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          ││
│  │  │  NAT 穿透    │  │  中继连接    │  │  流复用      │          ││
│  │  └──────────────┘  └──────────────┘  └──────────────┘          ││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 数据流架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        数据包处理流程                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐     │
│  │ 应用程序 │───▶│ TUN接口  │───▶│ 帧解析   │───▶│ 路由查找 │     │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘     │
│                                                       │             │
│                                                       ▼             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐     │
│  │ 目标节点 │◀───│ P2P网络  │◀───│ 流传输   │◀───│ 账本查询 │     │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.3 消息传播架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        消息传播流程                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐     │
│  │ 本地账本 │───▶│ 序列化   │───▶│ 压缩     │───▶│ 加密     │     │
│  │ 更新     │    │          │    │ (gzip)   │    │ (AES)    │     │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘     │
│                                                       │             │
│                                                       ▼             │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐     │
│  │ 账本更新 │◀───│ 解析     │◀───│ 解压     │◀───│ GossipSub│     │
│  └──────────┘    └──────────┘    └──────────┘    │ 广播     │     │
│                                                   └──────────┘     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 模块说明

### 3.1 核心模块 (pkg/node)

**职责**：节点生命周期管理、网络连接维护、消息路由

**核心组件**：

| 组件 | 文件 | 描述 |
|------|------|------|
| Node | node.go | 节点主结构体，管理所有子系统 |
| Config | config.go | 节点配置管理 |
| Connection | connection.go | 连接数据处理 |
| Message | message.go | 消息处理 |
| Options | options.go | 配置选项模式 |

**核心接口**：

```go
// Node 节点结构体
type Node struct {
    config     Config              // 节点配置
    MessageHub *hub.MessageHub     // 消息中心
    inputCh    chan *hub.Message   // 输入消息通道
    host       host.Host           // libp2p主机
    ledger     *blockchain.Ledger  // 区块链账本
}

// 主要方法
func New(p ...Option) (*Node, error)     // 创建新节点
func (e *Node) Start(ctx context.Context) error  // 启动节点
func (e *Node) Ledger() (*blockchain.Ledger, error) // 获取账本
```

### 3.2 VPN 模块 (pkg/vpn)

**职责**：虚拟网络接口管理、数据包转发、DHCP 服务

**核心组件**：

| 组件 | 文件 | 描述 |
|------|------|------|
| VPN | vpn.go | VPN 核心服务 |
| Config | config.go | VPN 配置 |
| DHCP | dhcp.go | DHCP 服务器 |
| Interface | interface.go | 网络接口抽象 |
| Interface_* | interface_*.go | 平台特定实现 |

**核心流程**：

```go
// VPN 网络服务
func VPNNetworkService(p ...Option) node.NetworkService {
    // 1. 创建网络接口
    // 2. 设置流处理器
    // 3. 公告 IP 地址
    // 4. 启动数据包读取循环
}

// 数据包处理流程
func readPackets(ctx, mgr, c, n, ledger, ifce, nc) error {
    // 1. 从 TUN 接口读取以太网帧
    // 2. 解析 IP 头获取目标地址
    // 3. 从账本查询目标节点
    // 4. 建立 P2P 流并转发数据
}
```

### 3.3 区块链模块 (pkg/blockchain)

**职责**：分布式状态存储、数据同步、一致性保证

**核心组件**：

| 组件 | 文件 | 描述 |
|------|------|------|
| Ledger | ledger.go | 账本主结构 |
| Block | block.go | 区块定义 |
| Data | data.go | 数据封装 |
| MemoryStore | store_memory.go | 内存存储 |
| DiskStore | store_disk.go | 磁盘存储 |

**核心接口**：

```go
// Ledger 账本结构体
type Ledger struct {
    sync.Mutex
    blockchain Store    // 区块链存储
    channel    io.Writer // 写入通道
}

// 主要方法
func New(w io.Writer, s Store) *Ledger           // 创建账本
func (l *Ledger) Add(b string, s map[string]interface{}) // 添加数据
func (l *Ledger) GetKey(b, s string) (Data, bool) // 查询数据
func (l *Ledger) Announce(ctx, d, async)         // 公告更新
func (l *Ledger) Syncronizer(ctx, t)             // 同步器
```

### 3.4 消息中心模块 (pkg/hub)

**职责**：消息发布订阅、房间管理、消息加密

**核心组件**：

| 组件 | 文件 | 描述 |
|------|------|------|
| MessageHub | hub.go | 消息中心主结构 |
| Room | room.go | 房间管理 |
| Message | message.go | 消息定义 |

**核心机制**：

```go
// MessageHub 消息中心
type MessageHub struct {
    blockchain, public *room        // 区块链房间和公共房间
    ps                 *pubsub.PubSub // 发布订阅服务
    otpKey             string         // OTP密钥
    Messages           chan *Message  // 消息通道
}

// 动态主题密钥
func (m *MessageHub) topicKey(salts ...string) string {
    totp := crypto.TOTP(sha256.New, m.keyLength, m.interval, m.otpKey)
    return crypto.MD5(totp)
}
```

### 3.5 发现模块 (pkg/discovery)

**职责**：节点发现、连接建立、中继管理

**核心组件**：

| 组件 | 文件 | 描述 |
|------|------|------|
| DHT | dht.go | DHT 发现服务 |
| mDNS | mdns.go | mDNS 发现服务 |
| Ring | ring.go | 历史记录环 |
| Address | address.go | 地址处理 |

**DHT 发现流程**：

```go
// DHT 发现服务
func (d *DHT) Run(c, ctx, host) error {
    // 1. 启动 Kademlia DHT
    // 2. 连接引导节点
    // 3. 公告会合点
    // 4. 搜索其他节点
    // 5. 建立连接
}
```

### 3.6 加密模块 (pkg/crypto)

**职责**：数据加密、密钥管理、TOTP 生成

**核心组件**：

| 组件 | 文件 | 描述 |
|------|------|------|
| AES | aes.go | AES-GCM 加密 |
| Sealer | sealer_aes.go | 密封器实现 |
| OTP | otp.go | TOTP 生成 |
| MD5 | md5.go | MD5 哈希 |

**加密接口**：

```go
// AES 加密
func AESEncrypt(plaintext string, key *[32]byte) (string, error)
func AESDecrypt(text string, key *[32]byte) (string, error)

// TOTP 生成
func TOTP(hash func() hash.Hash, digits, interval int, secret string) string
```

### 3.7 服务模块 (pkg/services)

**职责**：网络服务实现、DNS、文件传输、存活检测

**核心组件**：

| 组件 | 文件 | 描述 |
|------|------|------|
| Services | services.go | 服务注册与连接 |
| DNS | dns.go | DNS 服务器 |
| Files | files.go | 文件传输服务 |
| Alive | alive.go | 存活检测服务 |
| Egress | egress.go | 出口网关服务 |

### 3.8 信任区域模块 (pkg/trustzone)

**职责**：节点认证、访问控制、安全策略

**核心组件**：

| 组件 | 文件 | 描述 |
|------|------|------|
| PeerGuardian | peerguardian.go | 对等节点守护者 |
| PeerGater | peergater.go | 对等节点门控器 |
| ECDSA Provider | authprovider/ecdsa/ | ECDSA 认证提供者 |

### 3.9 类型模块 (pkg/types)

**职责**：数据类型定义、序列化支持

**核心类型**：

| 类型 | 文件 | 描述 |
|------|------|------|
| Machine | machine.go | 机器信息 |
| User | user.go | 用户信息 |
| Service | service.go | 服务信息 |
| File | file.go | 文件信息 |
| DNS | dns.go | DNS 记录 |
| Summary | summary.go | 摘要信息 |

### 3.10 API 模块 (api/)

**职责**：REST API 服务、状态查询、客户端 SDK

**核心组件**：

| 组件 | 文件 | 描述 |
|------|------|------|
| API | api.go | API 服务器 |
| Client | client/client.go | API 客户端 |
| Types | types/*.go | API 类型定义 |

---

## 4. 核心接口定义

### 4.1 网络服务接口

```go
// NetworkService 网络服务函数类型
type NetworkService func(ctx context.Context, c Config, n *Node, b *blockchain.Ledger) error

// StreamHandler 流处理器函数类型
type StreamHandler func(n *Node, l *blockchain.Ledger) func(stream network.Stream)
```

### 4.2 存储接口

```go
// Store 存储接口
type Store interface {
    Add(Block)   // 添加区块
    Len() int    // 返回长度
    Last() Block // 返回最后区块
}
```

### 4.3 密封器接口

```go
// Sealer 密封器接口
type Sealer interface {
    Seal(string) (string, error)     // 密封数据
    Unseal(string) (string, error)   // 解封数据
}
```

### 4.4 门控器接口

```go
// Gater 门控器接口
type Gater interface {
    Gate(network.Stream) bool  // 门控检查
}
```

### 4.5 发现服务接口

```go
// ServiceDiscovery 服务发现接口
type ServiceDiscovery interface {
    Run(log.StandardLogger, context.Context, host.Host) error
}
```

---

## 5. 数据流程

### 5.1 节点启动流程

```
1. 解析配置文件/命令行参数
       ↓
2. 创建节点实例 (node.New)
       ↓
3. 初始化账本 (blockchain.New)
       ↓
4. 启动 libp2p 主机
       ↓
5. 启动服务发现 (DHT/mDNS)
       ↓
6. 加入消息房间 (GossipSub)
       ↓
7. 创建 TUN 接口
       ↓
8. 启动网络服务 (VPN/DNS/等)
       ↓
9. 进入数据包处理循环
```

### 5.2 数据包转发流程

```
1. 应用程序发送数据包
       ↓
2. 数据包进入 TUN 接口
       ↓
3. 读取以太网帧
       ↓
4. 解析 IP 头部
       ↓
5. 提取目标 IP 地址
       ↓
6. 查询账本获取目标节点 ID
       ↓
7. 建立 P2P 流连接
       ↓
8. 发送帧数据到目标节点
       ↓
9. 目标节点接收并写入 TUN
       ↓
10. 目标应用程序接收数据
```

### 5.3 账本同步流程

```
1. 本地账本数据变更
       ↓
2. 创建新区块
       ↓
3. 序列化区块数据
       ↓
4. Gzip 压缩
       ↓
5. 发布到 GossipSub
       ↓
6. 其他节点接收消息
       ↓
7. 解压并解析区块
       ↓
8. 验证区块有效性
       ↓
9. 添加到本地区块链
```

---

## 6. 依赖关系

### 6.1 模块依赖图

```
cmd/
  ├── pkg/node (节点核心)
  ├── pkg/vpn (VPN服务)
  ├── pkg/services (网络服务)
  └── api (API服务)

pkg/node/
  ├── pkg/blockchain (区块链)
  ├── pkg/hub (消息中心)
  ├── pkg/discovery (节点发现)
  ├── pkg/crypto (加密)
  └── pkg/logger (日志)

pkg/vpn/
  ├── pkg/node (节点)
  ├── pkg/blockchain (区块链)
  ├── pkg/stream (流管理)
  ├── pkg/types (类型)
  └── pkg/protocol (协议)

pkg/services/
  ├── pkg/node (节点)
  ├── pkg/blockchain (区块链)
  └── pkg/types (类型)

pkg/hub/
  ├── pkg/crypto (加密)
  └── libp2p-pubsub

pkg/discovery/
  ├── pkg/crypto (加密)
  └── libp2p-kad-dht
```

### 6.2 外部依赖

| 依赖包 | 版本 | 用途 |
|--------|------|------|
| github.com/libp2p/go-libp2p | v0.45.0 | P2P 网络框架 |
| github.com/libp2p/go-libp2p-kad-dht | v0.36.0 | DHT 实现 |
| github.com/libp2p/go-libp2p-pubsub | v0.15.0 | 发布订阅 |
| github.com/google/gopacket | v1.1.19 | 数据包解析 |
| github.com/mudler/water | latest | TUN 接口 |
| github.com/labstack/echo/v4 | v4.13.3 | HTTP 框架 |
| github.com/urfave/cli/v2 | v2.27.7 | CLI 框架 |
| golang.org/x/crypto | v0.45.0 | 加密库 |

---

## 7. 部署指南

### 7.1 系统要求

| 要求 | 说明 |
|------|------|
| 操作系统 | Linux / macOS / Windows / FreeBSD |
| Go 版本 | 1.24 或更高 |
| 权限 | 需要 root/管理员权限创建 TUN 接口 |
| 网络 | 需要能够访问互联网（用于 DHT 引导） |

### 7.2 快速部署

#### 方式一：直接安装

```bash
# 使用安装脚本
curl -fsSL https://raw.githubusercontent.com/purpose168/edgevpn/master/install.sh | bash

# 或使用 Go 安装
go install github.com/purpose168/edgevpn@latest
```

#### 方式二：Docker 部署

```bash
# 使用 Docker Compose
docker-compose up -d

# 或直接运行
docker run --cap-add=NET_ADMIN --device /dev/net/tun \
  -e EDGEVPN_CONFIG="<配置内容>" \
  mudler/edgevpn
```

#### 方式三：从源码构建

```bash
# 克隆仓库
git clone https://github.com/purpose168/edgevpn.git
cd edgevpn

# 构建
go build -o edgevpn .

# 安装
sudo mv edgevpn /usr/local/bin/
```

### 7.3 配置说明

#### 生成配置

```bash
# 生成 YAML 格式配置
edgevpn --g

# 生成 Base64 格式配置（适合作为令牌）
edgevpn --g --b
```

#### 配置文件示例

```yaml
libp2p:
  discovery:
    dht:
      enabled: true
      rendezvous: "edgevpn-demo"
      bootstrap_peers: []
    mdns:
      enabled: true
  stream:
    max_connections: 30
  nat:
    enabled: true
  relay:
    enabled: true
    static: []
  identity:
    privkey: "<私钥>"
    otp:
      key: "<OTP密钥>"
      interval: 360
      length: 12
  room: "edgevpn-room"
  max_message_size: 2097152
  seal_key_interval: 3600
  seal_key_length: 32

vpn:
  interface:
    name: "edgevpn0"
    address: "10.1.0.1/24"
    mtu: 1400
  router:
    enabled: false
    address: ""
```

### 7.4 命令行使用

#### 启动 VPN 节点

```bash
# 基本启动
edgevpn --config config.yaml

# 启用 API 服务
edgevpn --config config.yaml --api --api-listen 127.0.0.1:8080

# 启用 DHCP
edgevpn --config config.yaml --dhcp --address 10.1.0.0/24

# 启用 DNS 服务
edgevpn --config config.yaml --dns 53

# 启用出口网关
edgevpn --config config.yaml --egress
```

#### 服务暴露

```bash
# 暴露本地服务到 P2P 网络
edgevpn service expose --service-id myservice --address 127.0.0.1:8080

# 连接到远程服务
edgevpn service connect --service-id myservice --address 127.0.0.1:8888
```

#### 文件传输

```bash
# 发送文件
edgevpn file send --file /path/to/file

# 接收文件
edgevpn file receive --file /path/to/save
```

### 7.5 网络配置

#### Linux

```bash
# 加载 TUN 模块
sudo modprobe tun

# 设置 IP 转发（如需路由功能）
sudo sysctl -w net.ipv4.ip_forward=1

# 配置防火墙规则
sudo iptables -A FORWARD -i edgevpn0 -j ACCEPT
sudo iptables -A FORWARD -o edgevpn0 -j ACCEPT
```

#### macOS

```bash
# 安装 tuntap 驱动
brew install tuntap
```

#### Windows

```bash
# 安装 Wintun 驱动（自动处理）
# 或下载 WireGuard 安装包
```

---

## 附录

### A. 协议定义

| 协议 | ID | 描述 |
|------|-----|------|
| EdgeVPN | /edgevpn/1.0.0 | VPN 数据传输协议 |
| ServiceProtocol | /edgevpn/service/1.0.0 | 服务代理协议 |
| FileProtocol | /edgevpn/file/1.0.0 | 文件传输协议 |

### B. 账本存储桶

| 存储桶 | 键 | 值类型 | 描述 |
|--------|-----|--------|------|
| machines | IP地址 | Machine | 机器信息 |
| users | PeerID | User | 用户信息 |
| services | 服务ID | Service | 服务信息 |
| files | 文件ID | File | 文件信息 |
| dns | 域名 | DNS | DNS记录 |

### C. 错误码

| 错误码 | 描述 |
|--------|------|
| E001 | 无法创建 TUN 接口 |
| E002 | 配置文件解析失败 |
| E003 | DHT 引导失败 |
| E004 | 节点连接超时 |
| E005 | 账本同步失败 |

### D. 性能指标

| 指标 | 建议值 | 说明 |
|------|--------|------|
| MaxStreams | 30 | 最大并发流数量 |
| ChannelBufferSize | 1000 | 通道缓冲区大小 |
| MTU | 1400 | 最大传输单元 |
| LedgerAnnounceTime | 5s | 账本公告间隔 |
| DiscoveryInterval | 5min | 发现间隔 |

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-13  
**联系方式**: purpose168@outlook.com

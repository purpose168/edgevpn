# ============================================================================
# Dependabot 自动合并工作流
# 用途：自动批准并合并 Dependabot 机器人创建的依赖更新 PR
# 触发条件：由 Dependabot 机器人创建的拉取请求
# 作者：purpose168@outlook.com
# ============================================================================

name: Dependabot 自动合并
on:
#- pull_request_target  # 当前已禁用，需要时取消注释

permissions:
  contents: write       # 写入仓库内容的权限
  pull-requests: write  # 写入拉取请求的权限
  packages: read        # 读取包的权限

jobs:
  dependabot:
    runs-on: ubuntu-latest
    # 仅当 PR 作者为 dependabot[bot] 时才执行
    if: ${{ github.actor == 'dependabot[bot]' }}
    steps:
      # 获取 Dependabot 元数据
      - name: Dependabot 元数据
        id: metadata
        uses: dependabot/fetch-metadata@v2.4.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
          skip-commit-verification: true  # 跳过提交验证

      # 检出代码仓库
      - name: 检出代码仓库
        uses: actions/checkout@v4

      # 批准 PR（如果尚未被批准）
      - name: 批准 PR（如果尚未被批准）
        run: |
          # 检出 PR 分支
          gh pr checkout "$PR_URL"
          # 检查 PR 是否已被批准
          if [ "$(gh pr status --json reviewDecision -q .currentBranch.reviewDecision)" != "APPROVED" ];
          then
            # 如果未被批准，则批准该 PR
            gh pr review --approve "$PR_URL"
          else
            # 如果已被批准，输出提示信息
            echo "PR 已被批准。";
          fi
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

      # 为 Dependabot PR 启用自动合并
      - name: 为 Dependabot PR 启用自动合并
        # 仅当 PR 标题包含 'bump' 时才启用自动合并
        if: ${{ contains(github.event.pull_request.title, 'bump')}}
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}
